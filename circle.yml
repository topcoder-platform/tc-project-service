machine:

  node:
    version: v6.9.4
  environment:
    DB_MASTER_URL: postgres://ubuntu:@127.0.0.1:5432/circle_test
    #RABBITMQ_URL: amqp://localhost:5672
    AUTH_SECRET: secret
    AUTH_DOMAIN: topcoder-dev.com
    LOG_LEVEL: debug
    APP_VERSION: v4

dependencies:
  pre:
    - pip install awsebcli
  override:
    - npm install
    - wget https://download.elastic.co/elasticsearch/release/org/elasticsearch/distribution/tar/elasticsearch/2.3.5/elasticsearch-2.3.5.tar.gz
    - tar -xvf elasticsearch-2.3.5.tar.gz
    - elasticsearch-2.3.5/bin/elasticsearch: {background: true}
    # Make sure that Elasticsearch is up before running tests:
    - sleep 10 && wget --waitretry=5 --retry-connrefused -v http://127.0.0.1:9200/


deployment:
  development:
    branch: dev
    commands:
      - ./ebs_deploy.sh tc-project-service DEV $CIRCLE_BUILD_NUM


  production:
    branch: ["master", "hotfix/increase-timeouts"]
    commands:
      - ./ebs_deploy.sh tc-project-service PROD $CIRCLE_BUILD_NUM

    # tag: /v[0-9]+(\.[0-9]+)*/
    # owner: appirio-tech
    # commands:
      # - ./ebs_deploy.sh tc-project-service PROD $CIRCLE_TAG

general:
  artifacts:
    - ./coverage

notify:
  webhooks:
    # slack - product-dev
    - url: https://hooks.slack.com/services/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

experimental:
  notify:
    branches:
      only:
        - master
